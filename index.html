<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎵 Worship The Lord</title>

  <!-- 🔌 Warm up Dropbox connection early -->
  <link rel="preconnect" href="https://content.dropboxapi.com" crossorigin>
  <link rel="dns-prefetch" href="https://content.dropboxapi.com">

  <!-- ✅ PWA -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" type="image/png" />
  <meta name="theme-color" content="#2c3e50" />

  <!-- ✅ STYLES -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eaf3fb;
      text-align: center;
      padding: 20px;
    }
    h1, h3 { color: #2c3e50; }

    select, button { padding: 5px 10px; margin: 5px; }

    .volume-control {
      display: flex; align-items: center; justify-content: center;
      margin: 10px;
    }
    .volume-control label {
      margin-right: 5px; width: 140px; text-align: right;
    }
    .volume-control input[type="range"] { width: 200px; }

    #lyricsArea {
      width: 95%; height: 500px; margin: 25px auto;
      padding: 20px; font-size: 1.4rem; line-height: 1.6;
      background-color: #fff; border: 2px solid #ccc;
      border-radius: 10px; white-space: pre-wrap; overflow-y: auto;
    }

    #segments { margin: 10px 0; }

    .segment-button {
      margin: 3px; padding: 4px 8px; font-size: 0.9rem;
    }

    #installPrompt {
      display: none; background: #fff8dc; border: 1px solid #ccc;
      padding: 10px; margin: 10px auto; width: 90%; font-size: 1rem;
    }

    .volume-control span {
      display: inline-block; width: 40px; text-align: left;
      font-weight: bold; margin-left: 6px; color: #2c3e50;
    }

    /* 🌈 Custom dropdown */
    .dropdown {
      position: relative; display: inline-block;
      width: 90%; max-width: 420px; font-size: 1.05rem;
    }
    .dropdown-selected {
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      padding: 8px 10px; cursor: pointer;
    }
    .dropdown-list {
      display: none; position: absolute; width: 100%;
      background: #fff; border: 1px solid #ccc; border-radius: 6px;
      max-height: 260px; overflow-y: auto; z-index: 1000;
    }
    .dropdown-item {
      padding: 6px 10px; border-bottom: 1px solid #eee; cursor: pointer;
    }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:hover { background: #f0f0f0; }

    #songDisplay { margin-top: 10px; line-height: 1.4; }

    /* 🔁 Segment Progress Bar Styling */
    .segment-button { position: relative; overflow: hidden; }
    .progress-bar {
      position: absolute; top: 0; bottom: 0; width: 3px;
      background-color: #4caf50; transition: left 0.05s ease-out;
    }
  </style>
</head>

<body>
  <h3>🎵 Worship The Lord</h3>

  <!-- ✅ PWA Install Prompt -->
  <div id="installPrompt">
    📲 You can install this app on your device.
    <button id="installButton">Install</button>
  </div>

  <!-- 🔽 Custom styled dropdown -->
  <div id="songDropdown" class="dropdown">
    <div id="dropdownSelected" class="dropdown-selected">-- Select a Song --</div>
    <div id="dropdownList" class="dropdown-list"></div>
  </div>

  <!-- ✅ Song display area -->
  <div id="songDisplay" style="margin-top:10px; font-size:1.3rem; line-height:1.5;"></div>

  <!-- ⭐️ Bookmark + Dropdown -->
  <div style="display:inline-flex; align-items:center; gap:6px;">
    <button id="bookmarkBtn" title="Toggle bookmark"
      style="font-size:1.4rem; border:none; background:none; cursor:pointer;">☆</button>
    <select id="bookmarkDropdown">
      <option value="">🎯 Bookmarked Songs</option>
    </select>
  </div>

  <!-- 🎵 Playback Controls -->
  <br />
  <button id="playBtn">▶️ Play</button>
  <button id="pauseBtn">⏸️ Pause</button>

  <!-- 🔊 Volume controls -->
  <div class="volume-control">
    <label for="vocalVolume">🎤 Vocal Volume:</label>
    <button onclick="adjustVolume('vocal', -0.1)">-</button>
    <input type="range" id="vocalVolume" min="0" max="1" step="0.01" value="1" />
    <span id="vocalVolumeDisplay">1.00</span>
    <button onclick="adjustVolume('vocal', 0.1)">+</button>
  </div>

  <div class="volume-control">
    <label for="accompVolume">🏛️ Accompaniment Volume:</label>
    <button onclick="adjustVolume('accomp', -0.1)">-</button>
    <input type="range" id="accompVolume" min="0" max="1" step="0.01" value="1" />
    <span id="accompVolumeDisplay">1.00</span>
    <button onclick="adjustVolume('accomp', 0.1)">+</button>
  </div>

  <!-- 🔁 Segment Buttons -->
  <div id="loopButtonsContainer"
       style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;">
  </div>

  <!-- ✅ Lyrics Area -->
  <textarea id="lyricsArea" readonly></textarea>

  <!-- ===================================================== -->
  <!-- Modular Script Loading (in correct order) -->
  <!-- ===================================================== -->

  <script src="WorshipApp_Modular/tokenLoader.js"></script>
  <script src="WorshipApp_Modular/favoriteSongs.js"></script>
  <script src="WorshipApp_Modular/songs_names.js"></script>
  <script src="WorshipApp_Modular/songNamesLoader.js"></script>
  <script src="WorshipApp_Modular/lyricsLoader.js"></script>

  <script>
    window.addEventListener("DOMContentLoaded", async () => {
      if (typeof loadSongNames === "function") await loadSongNames();
      if (typeof updateSongDisplayStyled === "function") updateSongDisplayStyled();
    });
  </script>

  <!-- ===================================================== -->
  <!-- Additional Logic & Controls -->
  <!-- ===================================================== -->
  <script src="WorshipApp_Modular/audioControl.js"></script>
  <script src="WorshipApp_Modular/skipControl.js"></script>
  <script src="WorshipApp_Modular/songLoader.js"></script>
  <script src="WorshipApp_Modular/bookmarkManager.js"></script>
  <script src="WorshipApp_Modular/pwaSetup.js"></script>
  <script src="WorshipApp_Modular/loopPlayer.js"></script>
  <script src="WorshipApp_Modular/segmentProgressVisualizer.js"></script>

  <!-- ✅ Service Worker (clean, single instance) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installBar = document.getElementById('installPrompt');
      if (installBar) installBar.style.display = 'block';
      const btn = document.getElementById('installButton');
      if (btn) {
        btn.onclick = async () => {
          installBar.style.display = 'none';
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
        };
      }
    });
  </script>
</body>
</html>
