<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎵 Worship The Lord</title>

  <!-- Preconnect for Dropbox or other external resources -->
  <link rel="preconnect" href="https://www.dropbox.com">
  <link rel="preconnect" href="https://worship-the-lord.netlify.app">

  <!-- Optional styles -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>🎵 Worship The Lord</h1>
  </header>

  <!-- Song selector -->
  <section>
    <label for="songSelect">Select Song:</label>
    <select id="songSelect">
      <option value="">--Choose a song--</option>
      <!-- Song options dynamically added via JS -->
    </select>
  </section>

  <!-- Lyrics display -->
  <section id="lyricsContainer">
    <pre id="lyricsArea">Loading lyrics...</pre>
  </section>

  <!-- Audio controls -->
  <section id="audioControls">
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
    <label for="vocalVolume">Vocal Volume:</label>
    <input type="range" id="vocalVolume" min="0.03" max="1" step="0.01" value="0.03">
    <label for="accompVolume">Accompaniment Volume:</label>
    <input type="range" id="accompVolume" min="0.03" max="1" step="0.01" value="0.15">
  </section>

  <!-- Scripts -->
  <script>
    // Ensure deferredPrompt declared only once
    window.deferredPrompt = window.deferredPrompt || null;

    // Wait until DOM is loaded before running other scripts
    document.addEventListener('DOMContentLoaded', () => {

      // --- songSelect element ---
      const songSelect = document.getElementById('songSelect');
      if (!songSelect) {
        console.warn('#songSelect not found!');
        return;
      }

      // Load song names (simplified loader)
      async function loadSongNames() {
        try {
          const res = await fetch('lyrics/');
          const html = await res.text();
          const matches = [...html.matchAll(/href="([^"]+\.txt)"/g)].map(m => m[1]);
          matches.forEach(file => {
            const option = document.createElement('option');
            option.value = file;
            option.textContent = file.replace('.txt','');
            songSelect.appendChild(option);
          });
          console.log('✅ Song names loaded');
        } catch(err) {
          console.error('❌ Failed to load song names:', err);
        }
      }
      loadSongNames();

      // --- Lyrics loader ---
      async function loadLyrics(filename) {
        if (!filename) return;
        const lyricsArea = document.getElementById('lyricsArea');
        lyricsArea.textContent = 'Loading...';
        try {
          const res = await fetch('lyrics/' + filename);
          if (!res.ok) throw new Error('Lyrics not found');
          const txt = await res.text();
          lyricsArea.textContent = txt;
          console.log('✅ Loaded lyrics for', filename);
        } catch(err) {
          lyricsArea.textContent = 'Lyrics not found';
          console.warn('⚠️', err.message);
        }
      }

      songSelect.addEventListener('change', (e) => {
        const filename = e.target.value;
        loadLyrics(filename);
      });

      // --- Audio elements ---
      window.vocalAudio = new Audio();
      window.accompAudio = new Audio();
      const MIN_VOL = 0.03;
      window.vocalAudio.volume = MIN_VOL;
      window.accompAudio.volume = 0.15;

      document.getElementById('playBtn').addEventListener('click', () => {
        window.vocalAudio.play();
        window.accompAudio.play();
      });
      document.getElementById('pauseBtn').addEventListener('click', () => {
        window.vocalAudio.pause();
        window.accompAudio.pause();
      });

      // Volume sliders
      document.getElementById('vocalVolume').addEventListener('input', e => {
        const val = Math.max(MIN_VOL, parseFloat(e.target.value));
        window.vocalAudio.volume = val;
      });
      document.getElementById('accompVolume').addEventListener('input', e => {
        const val = Math.max(MIN_VOL, parseFloat(e.target.value));
        window.accompAudio.volume = val;
      });

    }); // DOMContentLoaded end

    // --- Service Worker registration ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').then(() => {
        console.log('✅ Service Worker registered');
      }).catch(err => {
        console.warn('❌ Service Worker failed:', err);
      });
    }
  </script>
</body>
</html>
