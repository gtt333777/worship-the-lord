<script>
  window.onload = async () => {
    const songNames = await loadSongNames(); // ✅ Load song names
    renderBookmarkFolders();                 // ✅ Show Favorites

    const select = document.getElementById("songSelect");
    loadLyricsForSelectedSong(select);       // ✅ Load lyrics for selected song
    select.addEventListener("change", () => {
      loadLyricsForSelectedSong(select);

      // ✅ Call this function to preload loop segments and show buttons
      const songName = select.value;
      onSongSelectionChange(songName);  // 🔁 Loads loop JSON + prepares segment buttons
    });

    document.getElementById("bookmarkThisBtn").style.display = "inline-block";
    document.getElementById("favoriteSelect").style.display = "inline-block";
    document.getElementById("bookmarkThisBtn").onclick = () => {
      const selectedSong = select.value.trim();
      const folder = document.getElementById("favoriteSelect").value;
      if (selectedSong && folder) {
        setCurrentFolder(folder);             // ✅ Use defined global functions
        bookmarkCurrentSong();                // ✅ Safe call
        alert(`⭐ '${selectedSong}' added to ${folder}`);
      }
    };
  }; // ✅ close the async window.onload function
</script>

<!-- ✅ Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(console.error);
  }

  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    const installBar = document.getElementById('installPrompt');
    if (installBar) installBar.style.display = 'block';

    document.getElementById('installButton').onclick = async () => {
      installBar.style.display = 'none';
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
    };
  });
</script>

<script>
  window.onload = async () => {
    loadBookmarks();           // ✅ initialize bookmarks
    showBookmarkFolders();     // ✅ render folders

    const songNames = await loadSongNames(); // ✅ Load song names into dropdown
    const select = document.getElementById("songSelect");
    loadLyricsForSelectedSong(select);       // ✅ Load lyrics
    select.addEventListener("change", () => loadLyricsForSelectedSong(select));

    // ✅ Show bookmark UI elements
    document.getElementById("bookmarkThisBtn").style.display = "inline-block";
    document.getElementById("favoriteSelect").style.display = "inline-block";

    // ✅ Handle bookmark button click
    document.getElementById("bookmarkThisBtn").onclick = () => {
      const selectedSong = select.value.trim();
      const folder = document.getElementById("favoriteSelect").value;
      if (selectedSong && folder) {
        setCurrentFolder(folder);
        bookmarkCurrentSong();
        alert(`⭐ '${selectedSong}' added to ${folder}`);
        document.getElementById("toggleFoldersBtn").onclick = toggleFolders;
      }
    };
  };
</script>

<!-- 🔊 Hidden audio players for sync -->
<audio id="vocalAudio" hidden></audio>
<audio id="accompAudio" hidden></audio>
